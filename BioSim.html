<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Biomechanics Lift Simulator with Force Diagrams</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .header p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1rem;
    }

    .container {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .control-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      height: fit-content;
    }

    .control-group {
      margin-bottom: 25px;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .control-group label {
      display: block;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    select, input[type="number"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }

    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    .slider-container {
      position: relative;
      margin-top: 10px;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(to right, #667eea, #764ba2);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .slider-value {
      position: absolute;
      right: 0;
      top: -30px;
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .btn {
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #f7fafc;
      color: #4a5568;
      border: 2px solid #e2e8f0;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
    }

    .btn-primary:hover {
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
    }

    .visualization {
      display: grid;
      grid-template-rows: 1fr auto;
      gap: 20px;
    }

    .animation-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .animation-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }

    #animationCanvas {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-2px);
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.9rem;
      color: #718096;
      font-weight: 500;
    }

    .result-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .result-panel h3 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    #resultGraph {
      width: 100%;
      height: 250px;
      border-radius: 12px;
    }

    #forceDiagram {
      width: 100%;
      height: 250px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .lift-indicator {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .lift-bench { background: #e6fffa; color: #00695c; }
    .lift-squat { background: #f0fff4; color: #2f855a; }
    .lift-deadlift { background: #fff5f5; color: #c53030; }

    .real-time-feedback {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .real-time-feedback.show {
      opacity: 1;
    }

    .force-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      font-size: 0.8rem;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
      border: 1px solid rgba(0,0,0,0.2);
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .result-panel {
        grid-template-columns: 1fr;
      }
    }

    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üèãÔ∏è Biomechanics Lift Simulator</h1>
    <p>Interactive analysis of lift mechanics and muscle forces</p>
  </div>

  <div class="container">
    <div class="control-panel">
      <div class="control-group">
        <label for="liftType">Select Lift Type:</label>
        <select id="liftType">
          <option value="bench">üèãÔ∏è Bench Press</option>
          <option value="squat">üèÉ Squat</option>
          <option value="deadlift">üí™ Deadlift</option>
        </select>
        <div id="liftIndicator" class="lift-indicator lift-bench">Bench Press</div>
      </div>

      <div class="control-group">
        <label for="joint1Angle" id="joint1Label">Shoulder Angle (deg):</label>
        <div class="slider-container">
          <input type="range" id="joint1Angle" min="0" max="180" value="0">
          <span id="joint1AngleValue" class="slider-value">0¬∞</span>
        </div>
      </div>

      <div class="control-group">
        <label for="joint2Angle" id="joint2Label">Elbow Angle (deg):</label>
        <div class="slider-container">
          <input type="range" id="joint2Angle" min="0" max="180" value="90">
          <span id="joint2AngleValue" class="slider-value">90¬∞</span>
        </div>
      </div>

      <div class="control-group">
        <label for="insertion1" id="insertion1Label">Shoulder Insertion (cm):</label>
        <div class="slider-container">
          <input type="range" id="insertion1" min="1" max="10" value="5" step="0.1">
          <span id="insertion1Value" class="slider-value">5.0 cm</span>
        </div>
      </div>

      <div class="control-group">
        <label for="insertion2" id="insertion2Label">Elbow Insertion (cm):</label>
        <div class="slider-container">
          <input type="range" id="insertion2" min="1" max="10" value="5" step="0.1">
          <span id="insertion2Value" class="slider-value">5.0 cm</span>
        </div>
      </div>

      <div class="control-group">
        <label for="force1" id="force1Label">Shoulder Muscle Force (N):</label>
        <input type="number" id="force1" value="800" min="0" max="2000">
      </div>

      <div class="control-group">
        <label for="force2" id="force2Label">Elbow Muscle Force (N):</label>
        <input type="number" id="force2" value="800" min="0" max="2000">
      </div>

      <button class="btn btn-primary" onclick="simulateLift()">
        üöÄ Simulate Lift
        <div class="loading-spinner" id="loadingSpinner"></div>
      </button>
      <button class="btn btn-secondary" onclick="exportData()">üìä Export Data</button>
      <button class="btn btn-secondary" onclick="resetSimulation()">üîÑ Reset</button>
    </div>

    <div class="visualization">
      <div class="animation-container">
        <canvas id="animationCanvas" width="600" height="400"></canvas>
        <div class="real-time-feedback" id="feedback"></div>
        
        <div class="metrics-grid" id="metricsGrid">
          <div class="metric-card">
            <div class="metric-value" id="torque1Value">0</div>
            <div class="metric-label" id="torque1Label">Shoulder Torque (Nm)</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="torque2Value">0</div>
            <div class="metric-label" id="torque2Label">Elbow Torque (Nm)</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="maxWeightKg">0</div>
            <div class="metric-label">Max Weight (kg)</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="maxWeightLbs">0</div>
            <div class="metric-label">Max Weight (lbs)</div>
          </div>
        </div>
      </div>

      <div class="result-panel">
        <div>
          <h3>üìà Torque Analysis</h3>
          <canvas id="resultGraph" width="600" height="300"></canvas>
        </div>
        <div>
        
        </div>
      </div>
    </div>
  </div>

  <script>
    const liftJoints = {
      bench: ['Shoulder', 'Elbow'],
      squat: ['Hip', 'Knee'],
      deadlift: ['Hip']
    };

    const leverArms = {
      bench: { Shoulder: 0.3, Elbow: 0.2 },
      squat: { Hip: 0.4, Knee: 0.3 },
      deadlift: { Hip: 0.5 }
    };

    const liftColors = {
      bench: '#00695c',
      squat: '#2f855a',
      deadlift: '#c53030'
    };

    // Force diagram colors
    const forceColors = {
      muscleForce: '#FF4136',   // Red
      jointForce: '#0074D9',    // Blue
      weightForce: '#2ECC40',   // Green
      torqueVector: '#FF851B'   // Orange
    };

    let animationId;
    let currentLift = 'bench';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      updateLiftType();
      setupRealTimeUpdates();
      simulateLift();
    });

    // Update lift type and labels
    function updateLiftType() {
      const lift = document.getElementById("liftType").value;
      currentLift = lift;
      const joints = liftJoints[lift];
      
      // Update control labels
      document.getElementById("joint1Label").textContent = `${joints[0]} Angle (deg):`;
      document.getElementById("joint2Label").textContent = `${joints[1]} Angle (deg):`;
      document.getElementById("insertion1Label").textContent = `${joints[0]} Insertion (cm):`;
      document.getElementById("insertion2Label").textContent = `${joints[1]} Insertion (cm):`;
      document.getElementById("force1Label").textContent = `${joints[0]} Muscle Force (N):`;
      document.getElementById("force2Label").textContent = `${joints[1]} Muscle Force (N):`;
      
      // Update metric labels
      document.getElementById("torque1Label").textContent = `${joints[0]} Torque (Nm)`;
      document.getElementById("torque2Label").textContent = `${joints[1]} Torque (Nm)`;
      
      // Update lift indicator
      const indicator = document.getElementById("liftIndicator");
      indicator.className = `lift-indicator lift-${lift}`;
      indicator.textContent = lift.charAt(0).toUpperCase() + lift.slice(1);
      
      simulateLift();
    }

    // Setup real-time updates
    function setupRealTimeUpdates() {
      const sliders = ['joint1Angle', 'joint2Angle', 'insertion1', 'insertion2'];
      const forces = ['force1', 'force2'];
      
      sliders.forEach(id => {
        const slider = document.getElementById(id);
        const valueSpan = document.getElementById(`${id}Value`);
        
        slider.addEventListener('input', function() {
          const value = parseFloat(this.value);
          if (id.includes('Angle')) {
            valueSpan.textContent = `${value}¬∞`;
          } else if (id.includes('insertion')) {
            valueSpan.textContent = `${value.toFixed(1)} cm`;
          }
          
          // Real-time simulation
          clearTimeout(slider.updateTimeout);
          slider.updateTimeout = setTimeout(() => {
            simulateLift();
            showFeedback(`Updated ${id.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
          }, 100);
        });
      });
      
      forces.forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener('input', function() {
          clearTimeout(input.updateTimeout);
          input.updateTimeout = setTimeout(() => {
            simulateLift();
            showFeedback(`Updated ${id.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
          }, 300);
        });
      });
      
      document.getElementById("liftType").addEventListener('change', updateLiftType);
    }

    // Show real-time feedback
    function showFeedback(message) {
      const feedback = document.getElementById("feedback");
      feedback.textContent = message;
      feedback.classList.add('show');
      
      clearTimeout(feedback.hideTimeout);
      feedback.hideTimeout = setTimeout(() => {
        feedback.classList.remove('show');
      }, 2000);
    }

    // Main simulation function
    function simulateLift() {
      const lift = document.getElementById("liftType").value;
      const joints = liftJoints[lift];
      const angle1 = parseFloat(document.getElementById("joint1Angle").value);
      const angle2 = parseFloat(document.getElementById("joint2Angle").value);
      const insertion1 = parseFloat(document.getElementById("insertion1").value) / 100;
      const insertion2 = parseFloat(document.getElementById("insertion2").value) / 100;
      const force1 = parseFloat(document.getElementById("force1").value);
      const force2 = parseFloat(document.getElementById("force2").value);

      // Input validation
      if (angle1 < 0 || angle1 > 180 || angle2 < 0 || angle2 > 180) {
        showFeedback("‚ö†Ô∏è Joint angles must be between 0¬∞ and 180¬∞");
        return;
      }
      if (insertion1 <= 0 || insertion2 <= 0) {
        showFeedback("‚ö†Ô∏è Insertion points must be positive");
        return;
      }
      if (force1 < 0 || force2 < 0) {
        showFeedback("‚ö†Ô∏è Muscle forces must be non-negative");
        return;
      }

      const g = 9.8;

      // Compute torques
      const torque1 = force1 * insertion1 * Math.sin(angle1 * Math.PI / 180);
      const torque2 = force2 * insertion2 * Math.sin(angle2 * Math.PI / 180);

      // Get lever arms
      const lever1 = leverArms[lift][joints[0]];
      const lever2 = leverArms[lift][joints[1]];

      // Compute max mass
      const maxMass1 = torque1 / (g * lever1);
      const maxMass2 = torque2 / (g * lever2);
      const maxMass = Math.min(maxMass1, maxMass2);

      // Update metrics
      document.getElementById("torque1Value").textContent = torque1.toFixed(1);
      document.getElementById("torque2Value").textContent = torque2.toFixed(1);
      document.getElementById("maxWeightKg").textContent = maxMass.toFixed(1);
      document.getElementById("maxWeightLbs").textContent = (maxMass * 2.2046).toFixed(1);

      // Animate the figure
      animateStickFigure(lift, angle1, angle2);

      // Generate and draw graph
      const angles = Array.from({length: 37}, (_, i) => i * 5);
      const torques = angles.map(a => force1 * insertion1 * Math.sin(a * Math.PI / 180));
      drawGraph(angles, torques, `${joints[0]} Torque vs Angle`, liftColors[lift]);

      // Draw force diagram
    
    }

    // Enhanced stick figure animation
    function animateStickFigure(lift, angle1, angle2) {
      const canvas = document.getElementById("animationCanvas");
      const ctx = canvas.getContext("2d");
      
      // Clear and setup
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 4;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // Draw grid background
      drawGrid(ctx);
      
      // Set color based on lift type
      ctx.strokeStyle = liftColors[lift];
      ctx.fillStyle = liftColors[lift];
      
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      
      if (lift === 'bench') {
        drawEnhancedBenchPress(ctx, centerX, centerY, angle1, angle2);
      } else if (lift === 'squat') {
        drawEnhancedSquat(ctx, centerX, centerY, angle1, angle2);
      } else if (lift === 'deadlift') {
        drawEnhancedDeadlift(ctx, centerX, centerY, angle1, angle2);
      }
      
      // Draw force vectors
      drawForceVectors(ctx, lift, centerX, centerY, angle1, angle2);
    }

    // Draw background grid
    function drawGrid(ctx) {
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.05)';
      ctx.lineWidth = 1;
      
      for (let i = 0; i < ctx.canvas.width; i += 20) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, ctx.canvas.height);
        ctx.stroke();
      }
      
      for (let i = 0; i < ctx.canvas.height; i += 20) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(ctx.canvas.width, i);
        ctx.stroke();
      }
    }

    // Enhanced drawing functions
    function drawEnhancedBenchPress(ctx, centerX, centerY, angleShoulder, angleElbow) {
      ctx.lineWidth = 6;
      
      // Torso
      ctx.beginPath();
      ctx.moveTo(centerX, centerY + 50);
      ctx.lineTo(centerX, centerY - 50);
      ctx.stroke();
      
      // Head
      ctx.beginPath();
      ctx.arc(centerX, centerY - 70, 15, 0, 2 * Math.PI);
      ctx.fill();
      
      // Upper arm
      const shoulderX = centerX;
      const shoulderY = centerY - 30;
      const upperArmAngle = angleShoulder * Math.PI / 180;
      const elbowX = shoulderX + 60 * Math.sin(upperArmAngle);
      const elbowY = shoulderY - 60 * Math.cos(upperArmAngle);
      
      ctx.beginPath();
      ctx.moveTo(shoulderX, shoulderY);
      ctx.lineTo(elbowX, elbowY);
      ctx.stroke();
      
      // Forearm
      const forearmAngle = angleElbow * Math.PI / 180;
      const handX = elbowX + 50 * Math.sin(forearmAngle);
      const handY = elbowY - 50 * Math.cos(forearmAngle);
      
      ctx.beginPath();
      ctx.moveTo(elbowX, elbowY);
      ctx.lineTo(handX, handY);
      ctx.stroke();
      
      // Joints
      drawJoint(ctx, shoulderX, shoulderY, 'Shoulder');
      drawJoint(ctx, elbowX, elbowY, 'Elbow');
      
      // Barbell
      ctx.strokeStyle = '#2d3748';
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.moveTo(handX - 30, handY);
      ctx.lineTo(handX + 30, handY);
      ctx.stroke();
    }

    function drawEnhancedSquat(ctx, centerX, centerY, angleHip, angleKnee) {
    ctx.lineWidth = 6;
    
    // Torso
    const torsoAngle = angleHip * Math.PI / 180;
    const torsoEndX = centerX + 80 * Math.cos(torsoAngle);
    const torsoEndY = centerY - 80 * Math.sin(torsoAngle);
    
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(torsoEndX, torsoEndY);
    ctx.stroke();
    
    // Head
    ctx.beginPath();
    ctx.arc(torsoEndX, torsoEndY - 20, 15, 0, 2 * Math.PI);
    ctx.fill();
    
    // Thigh
    const kneeAngle = (180 - angleKnee) * Math.PI / 180;
    const kneeX = centerX + 60 * Math.cos(kneeAngle);
    const kneeY = centerY + 60 * Math.sin(kneeAngle);
    
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(kneeX, kneeY);
    ctx.stroke();
    
    // Shin
    ctx.beginPath();
    ctx.moveTo(kneeX, kneeY);
    ctx.lineTo(kneeX, centerY + 120);
    ctx.stroke();
    
    // Joints
    drawJoint(ctx, centerX, centerY, 'Hip');
    drawJoint(ctx, kneeX, kneeY, 'Knee');
}

    function drawEnhancedDeadlift(ctx, centerX, centerY, angleHip, angleBack) {
  ctx.lineWidth = 6;

  // Legs
  ctx.beginPath();
  ctx.moveTo(centerX, centerY);
  ctx.lineTo(centerX, centerY + 100);
  ctx.stroke();

  // Torso
  const torsoAngle = angleHip * Math.PI / 180;
  const backX = centerX + 80 * Math.sin(torsoAngle);
  const backY = centerY - 80 * Math.cos(torsoAngle);
  ctx.beginPath();
  ctx.moveTo(centerX, centerY);
  ctx.lineTo(backX, backY);
  ctx.stroke();

  // Arms
  ctx.beginPath();
  ctx.moveTo(backX, backY);
  ctx.lineTo(centerX, centerY + 80);
  ctx.stroke();

  // Head
  ctx.beginPath();
  ctx.arc(backX, backY - 20, 15, 0, 2 * Math.PI);
  ctx.fill();

  // Joints
  drawJoint(ctx, centerX, centerY, 'Hip');

  // Barbell
  ctx.strokeStyle = '#2d3748';
  ctx.lineWidth = 8;
  ctx.beginPath();
  ctx.moveTo(centerX - 40, centerY + 80);
  ctx.lineTo(centerX + 40, centerY + 80);
  ctx.stroke();

  // Hip Angle Indicator
  ctx.strokeStyle = '#FF4136'; // Red
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(centerX, centerY, 20, 0, torsoAngle, false);
  ctx.stroke();
  ctx.fillStyle = '#2d3748';
  ctx.fillText(`Hip: ${angleHip}¬∞`, centerX + 30, centerY - 20);

  // Back Angle Indicator (torso vs. horizontal)
  const backAngleDisplay = angleHip; // For now, tied to hip angle; adjust if redefined
  ctx.strokeStyle = '#0074D9'; // Blue
  ctx.beginPath();
  ctx.moveTo(centerX, centerY - 50);
  ctx.lineTo(centerX + 50, centerY - 50); // Horizontal line
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(centerX, centerY, 20, 0, -torsoAngle, true); // Angle from horizontal
  ctx.stroke();
  ctx.fillText(`Back: ${backAngleDisplay}¬∞`, centerX + 30, centerY - 40);
}

    function drawJoint(ctx, x, y, label) {
      // Joint circle
      ctx.save();
      ctx.fillStyle = 'white';
      ctx.strokeStyle = ctx.strokeStyle;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(x, y, 8, 0, 2 * Math.PI);
      ctx.fill();
      ctx.stroke();
      
      // Label
      ctx.fillStyle = '#2d3748';
      ctx.font = '12px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(label, x, y - 15);
      ctx.restore();
    }

    function drawForceVectors(ctx, lift, centerX, centerY, angle1, angle2) {
      const force1 = parseFloat(document.getElementById("force1").value);
      const force2 = parseFloat(document.getElementById("force2").value);
      
      // Scale forces for visualization
      const scale = 0.05;
      const force1Length = force1 * scale;
      const force2Length = force2 * scale;
      
      ctx.strokeStyle = forceColors.muscleForce;
      ctx.lineWidth = 3;
      ctx.setLineDash([5, 5]);
      
      if (lift === 'bench') {
        // Draw force vectors for bench press
        const shoulderX = centerX;
        const shoulderY = centerY - 30;
        const elbowX = shoulderX + 60 * Math.cos(angle1 * Math.PI / 180);
        const elbowY = shoulderY - 60 * Math.sin(angle1 * Math.PI / 180);
        
        // Shoulder force vector
        drawArrow(ctx, shoulderX, shoulderY, 
                 shoulderX + force1Length * Math.cos((angle1 + 90) * Math.PI / 180),
                 shoulderY - force1Length * Math.sin((angle1 + 90) * Math.PI / 180));
        
        // Elbow force vector
        drawArrow(ctx, elbowX, elbowY,
                 elbowX + force2Length * Math.cos((angle1 - angle2 + 90) * Math.PI / 180),
                 elbowY - force2Length * Math.sin((angle1 - angle2 + 90) * Math.PI / 180));
      } else if (lift === 'squat') {
        // Draw force vectors for squat
        const hipX = centerX;
        const hipY = centerY;
        
        // Thigh
        const kneeAngleRad = (180 - angle2) * Math.PI / 180;
        const kneeX = hipX + 60 * Math.cos(kneeAngleRad);
        const kneeY = hipY + 60 * Math.sin(kneeAngleRad);
        
        // Hip force vector
        const hipForceAngle = Math.atan2(kneeY - hipY, kneeX - hipX) + Math.PI/2;
        drawArrow(ctx, hipX, hipY, 
                 hipX + force1Length * Math.cos(hipForceAngle),
                 hipY + force1Length * Math.sin(hipForceAngle));
        
        // Knee force vector
        const kneeForceAngle = Math.atan2(hipY - kneeY, hipX - kneeX);
        drawArrow(ctx, kneeX, kneeY,
                 kneeX + force2Length * Math.cos(kneeForceAngle),
                 kneeY + force2Length * Math.sin(kneeForceAngle));
      } else if (lift === 'deadlift') {
        // Draw force vectors for deadlift
        const hipX = centerX;
        const hipY = centerY;
        
        // Torso
        const backAngleRad = angle1 * Math.PI / 180;
        const backX = centerX + 80 * Math.sin(backAngleRad);
        const backY = centerY - 80 * Math.cos(backAngleRad);
        const torsoAngle = Math.atan2(backY - hipY, backX - hipX);
        
        // Hip force vector
        drawArrow(ctx, hipX, hipY, 
                 hipX + force1Length * Math.cos(torsoAngle + Math.PI/2),
                 hipY + force1Length * Math.sin(torsoAngle + Math.PI/2));
        
        // Back force vector
       
      }
      
      ctx.setLineDash([]);
    }

    function drawArrow(ctx, fromX, fromY, toX, toY) {
      const headLength = 10;
      const angle = Math.atan2(toY - fromY, toX - fromX);
      
      // Arrow line
      ctx.beginPath();
      ctx.moveTo(fromX, fromY);
      ctx.lineTo(toX, toY);
      ctx.stroke();
      
      // Arrow head
      ctx.beginPath();
      ctx.moveTo(toX, toY);
      ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI/6), 
                toY - headLength * Math.sin(angle - Math.PI/6));
      ctx.moveTo(toX, toY);
      ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI/6), 
                toY - headLength * Math.sin(angle + Math.PI/6));
      ctx.stroke();
    }

    // Enhanced graph drawing
    function drawGraph(labels, data, title, color) {
      const ctx = document.getElementById("resultGraph").getContext("2d");
      if (window.myChart) window.myChart.destroy();
      
      window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: title,
            data: data,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: color,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.4,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: { family: 'Inter', size: 14, weight: '600' },
                color: '#4a5568'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: color,
              borderWidth: 2,
              cornerRadius: 8,
              displayColors: false
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Joint Angle (¬∞)',
                font: { family: 'Inter', size: 14, weight: '600' },
                color: '#4a5568'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                lineWidth: 1
              },
              ticks: {
                font: { family: 'Inter', size: 12 },
                color: '#718096'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Torque (Nm)',
                font: { family: 'Inter', size: 14, weight: '600' },
                color: '#4a5568'
              },
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                lineWidth: 1
              },
              ticks: {
                font: { family: 'Inter', size: 12 },
                color: '#718096'
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          animation: {
            duration: 750,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

    // Draw force diagram
    function drawForceDiagram(lift, angle1, angle2, insertion1, insertion2, force1, force2, torque1, torque2) {
      const canvas = document.getElementById("forceDiagram");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const joints = liftJoints[lift];
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      
      // Draw the lever system
      ctx.strokeStyle = '#2d3748';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(centerX - 100, centerY);
      ctx.lineTo(centerX + 100, centerY);
      ctx.stroke();
      
      // Draw fulcrum
      ctx.fillStyle = '#764ba2';
      ctx.beginPath();
      ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
      ctx.fill();
      
      // Draw lever arms
      ctx.strokeStyle = forceColors.torqueVector;
      ctx.lineWidth = 3;
      
      // Muscle force arm
      const muscleArmLength = 80 * (insertion1 / 10);
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(centerX - muscleArmLength, centerY);
      ctx.stroke();
      
      // Weight force arm
      const weightArmLength = 80 * (leverArms[lift][joints[0]]);
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(centerX + weightArmLength, centerY);
      ctx.stroke();
      
      // Draw forces
      // Muscle force
      const muscleForceLength = Math.min(60, force1 / 20);
      ctx.strokeStyle = forceColors.muscleForce;
      ctx.lineWidth = 4;
      drawArrow(ctx, centerX - muscleArmLength, centerY, 
                centerX - muscleArmLength, centerY - muscleForceLength);
      
      // Weight force
      const weightForceLength = Math.min(60, force2 / 20);
      ctx.strokeStyle = forceColors.weightForce;
      drawArrow(ctx, centerX + weightArmLength, centerY, 
                centerX + weightArmLength, centerY + weightForceLength);
      
      // Draw torque vectors
      ctx.strokeStyle = forceColors.torqueVector;
      ctx.lineWidth = 2;
      ctx.setLineDash([3, 3]);
      
      
      const muscleTorqueLength = Math.min(40, torque1 / 30);
      ctx.beginPath();
      ctx.arc(centerX, centerY, 15, -Math.PI/2, -Math.PI/2 - Math.PI/2 * (muscleTorqueLength/40), true);
      ctx.stroke();
      drawArrow(ctx, centerX, centerY - 15, centerX - 5, centerY - 15);
      
      // Weight torque
      const weightTorqueLength = Math.min(40, torque2 / 30);
      ctx.beginPath();
      ctx.arc(centerX, centerY, 15, Math.PI/2, Math.PI/2 + Math.PI/2 * (weightTorqueLength/40));
      ctx.stroke();
      drawArrow(ctx, centerX, centerY + 15, centerX + 5, centerY + 15);
      
      ctx.setLineDash([]);
      
      // Draw labels
      ctx.fillStyle = '#2d3748';
      ctx.font = 'bold 14px Inter, sans-serif';
      ctx.textAlign = 'center';
      
      ctx.fillText('Pivot', centerX, centerY + 25);
      ctx.fillText('Muscle Force', centerX - muscleArmLength, centerY - muscleForceLength - 10);
      ctx.fillText('Weight Force', centerX + weightArmLength, centerY + weightForceLength + 20);
      ctx.fillText('Muscle Torque', centerX - 30, centerY - 30);
      ctx.fillText('Weight Torque', centerX + 30, centerY + 40);
      
      // Draw mechanical advantage
      const advantage = (muscleArmLength / weightArmLength).toFixed(2);
      ctx.fillStyle = liftColors[lift];
      ctx.font = 'bold 16px Inter, sans-serif';
      ctx.fillText(`Mechanical Advantage: ${advantage}x`, centerX, centerY + 80);
    }

    // Export simulation data with enhanced formatting
    function exportData() {
      const spinner = document.getElementById('loadingSpinner');
      spinner.style.display = 'block';
      
      setTimeout(() => {
        const lift = document.getElementById("liftType").value;
        const joints = liftJoints[lift];
        const angle1 = parseFloat(document.getElementById("joint1Angle").value);
        const angle2 = parseFloat(document.getElementById("joint2Angle").value);
        const insertion1 = parseFloat(document.getElementById("insertion1").value);
        const insertion2 = parseFloat(document.getElementById("insertion2").value);
        const force1 = parseFloat(document.getElementById("force1").value);
        const force2 = parseFloat(document.getElementById("force2").value);
        const g = 9.8;

        const insertion1_m = insertion1 / 100;
        const insertion2_m = insertion2 / 100;
        const torque1 = force1 * insertion1_m * Math.sin(angle1 * Math.PI / 180);
        const torque2 = force2 * insertion2_m * Math.sin(angle2 * Math.PI / 180);
        const lever1 = leverArms[lift][joints[0]];
        const lever2 = leverArms[lift][joints[1]];
        const maxMass1 = torque1 / (g * lever1);
        const maxMass2 = torque2 / (g * lever2);
        const maxMass = Math.min(maxMass1, maxMass2);

        // Enhanced CSV with metadata
        let csv = "# Biomechanics Lift Simulator Export\n";
        csv += `# Generated: ${new Date().toLocaleString()}\n`;
        csv += `# Lift Type: ${lift.charAt(0).toUpperCase() + lift.slice(1)}\n`;
        csv += "#\n";
        csv += "Parameter,Value,Unit\n";
        csv += `Lift Type,${lift},-\n`;
        csv += `Joint 1,${joints[0]},-\n`;
        csv += `Joint 2,${joints[1]},-\n`;
        csv += `${joints[0]} Angle,${angle1},degrees\n`;
        csv += `${joints[1]} Angle,${angle2},degrees\n`;
        csv += `${joints[0]} Insertion,${insertion1},cm\n`;
        csv += `${joints[1]} Insertion,${insertion2},cm\n`;
        csv += `${joints[0]} Force,${force1},N\n`;
        csv += `${joints[1]} Force,${force2},N\n`;
        csv += `${joints[0]} Torque,${torque1.toFixed(2)},Nm\n`;
        csv += `${joints[1]} Torque,${torque2.toFixed(2)},Nm\n`;
        csv += `Max Weight,${maxMass.toFixed(2)},kg\n`;
        csv += `Max Weight,${(maxMass * 2.2046).toFixed(2)},lbs\n`;

        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `biomechanics_${lift}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        spinner.style.display = 'none';
        showFeedback("üìä Data exported successfully!");
      }, 500);
    }

    // Enhanced reset function
    function resetSimulation() {
      // Animate reset
      const controls = document.querySelectorAll('input, select');
      controls.forEach((control, index) => {
        setTimeout(() => {
          if (control.type === 'range') {
            control.value = control.id === 'joint1Angle' || control.id === 'joint2Angle' ? 90 : 5;
            const valueSpan = document.getElementById(`${control.id}Value`);
            if (valueSpan) {
              if (control.id.includes('Angle')) {
                valueSpan.textContent = `${control.value}¬∞`;
              } else if (control.id.includes('insertion')) {
                valueSpan.textContent = `${control.value.toFixed(1)} cm`;
              }
            }
          } else if (control.type === 'number') {
            control.value = 800;
          } else if (control.tagName === 'SELECT') {
            control.value = 'bench';
          }
        }, index * 50);
      });
      
      setTimeout(() => {
        updateLiftType();
        showFeedback("üîÑ Simulation reset successfully!");
      }, 300);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 's':
            e.preventDefault();
            simulateLift();
            break;
          case 'e':
            e.preventDefault();
            exportData();
            break;
          case 'r':
            e.preventDefault();
            resetSimulation();
            break;
        }
      }
    });

    const shortcuts = document.createElement('div');
    shortcuts.innerHTML = `
      <div style="position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; 
                  padding: 10px 15px; border-radius: 8px; font-size: 0.8rem; opacity: 0.7;">
        <div><kbd>Ctrl+S</kbd> Simulate</div>
        <div><kbd>Ctrl+E</kbd> Export</div>
        <div><kbd>Ctrl+R</kbd> Reset</div>
      </div>
    `;
    document.body.appendChild(shortcuts);
  </script>
</body>
</html>